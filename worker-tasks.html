<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>📋 قائمة الأعمال – TopClim</title>
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: #f1f1f1;
      margin: 0;
      padding: 20px;
      direction: rtl;
    }

    .container {
      max-width: 800px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    h2 {
      text-align: center;
      color: #007BFF;
      margin-bottom: 20px;
    }

    .filters {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-box {
      flex: 1;
      text-align: center;
      background: #e9ecef;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid transparent;
    }

    .filter-box.active {
      background: #007BFF;
      color: white;
      border-color: #0056b3;
    }

    .task {
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      background-color: #fafafa;
    }

    .task h3 {
      margin: 0 0 10px;
    }

    .task a {
      background-color: #007BFF;
      color: white;
      text-decoration: none;
      padding: 8px 15px;
      border-radius: 5px;
      display: inline-block;
      margin-top: 10px;
      transition: background-color 0.3s;
    }

    .task a:hover {
      background-color: #0056b3;
    }

    .date-picker {
      margin-top: 10px;
      text-align: center;
    }

    .date-picker input {
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>🛠️ الأعمال الخاصة بك</h2>

    <div class="filters">
      <div class="filter-box" id="yesterdayBox">📅 البارحة</div>
      <div class="filter-box active" id="todayBox">📆 اليوم</div>
      <div class="filter-box" id="tomorrowBox">📅 الغد</div>
    </div>

    <div class="date-picker">
      <input type="date" id="customDate">
    </div>

    <div id="tasksList">
      <p>🔄 جاري تحميل الأعمال...</p>
    </div>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getFirestore, collection, query, where, getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // إعداد Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBjbzbSd1XM9eyXrgKaVj6xnZgIJuQmbRI",
    authDomain: "topclim-3edfa.firebaseapp.com",
    projectId: "topclim-3edfa"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // جلب معرف العامل من localStorage
  const workerId = localStorage.getItem("workerId");
  if (!workerId) {
    window.location.href = "worker-login.html";
  }

  const tasksList = document.getElementById("tasksList");
  const todayInput = document.getElementById("customDate");
  const boxes = {
    yesterday: document.getElementById("yesterdayBox"),
    today: document.getElementById("todayBox"),
    tomorrow: document.getElementById("tomorrowBox")
  };

  // دالة لحساب تواريخ اليوم، البارحة، والغد بصيغة YYYY-MM-DD
  function dateString(offsetDays = 0) {
    const d = new Date();
    d.setDate(d.getDate() + offsetDays);
    return d.toISOString().split("T")[0];
  }

  let selectedDate = dateString(); // الافتراضي: اليوم

  function setActive(key) {
    Object.values(boxes).forEach(b => b.classList.remove("active"));
    boxes[key].classList.add("active");
    selectedDate = dateString(key === "yesterday" ? -1 : key === "tomorrow" ? 1 : 0);
    todayInput.value = selectedDate;
    loadTasks();
  }

  boxes.yesterday.onclick = () => setActive("yesterday");
  boxes.today.onclick = () => setActive("today");
  boxes.tomorrow.onclick = () => setActive("tomorrow");

  todayInput.value = selectedDate;
  todayInput.onchange = e => {
    Object.values(boxes).forEach(b => b.classList.remove("active"));
    selectedDate = e.target.value;
    loadTasks();
  };

  // تحميل المهام
  async function loadTasks() {
    tasksList.innerHTML = "⏳ جاري تحميل الأعمال...";
    try {
      const start = `${selectedDate}T00:00:00`;
      const end = `${selectedDate}T23:59:59`;

      const q = query(
        collection(db, "requests"),
        where("assignedTo", "==", workerId),
        where("executionSchedule", ">=", start),
        where("executionSchedule", "<=", end)
      );

      const snap = await getDocs(q);
      if (snap.empty) {
        tasksList.innerHTML = "<p>🚫 لا توجد أعمال في هذا التاريخ.</p>";
        return;
      }

      tasksList.innerHTML = "";
      snap.forEach(docSnap => {
        const d = docSnap.data();
        const dateDisplay = d.executionSchedule?.split("T")[0] || "";
        const el = document.createElement("div");
        el.className = "task";
        el.innerHTML = `
          <h3>👤 ${d.name || "زبون"}</h3>
          <p>📍 ${d.address || "غير محدد"}</p>
          <p>🕒 ${dateDisplay} – ${d.executionSchedule?.split("T")[1]?.slice(0,5) || ""}</p>
          <a href="worker-task-details.html?id=${docSnap.id}">📄 تنفيذ</a>
        `;
        tasksList.appendChild(el);
      });

    } catch (err) {
      console.error(err);
      tasksList.innerHTML = "<p>❌ خطأ أثناء التحميل.</p>";
    }
  }

  loadTasks();
</script>


</body>
</html>
