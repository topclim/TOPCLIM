<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ’° ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ â€“ TopClim</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: 'Cairo', sans-serif; background: #f4f6f8; padding: 20px; direction: rtl; }
    h1 { text-align: center; color: #007bff; }
    .controls { margin: 15px 0; text-align: center; }
    input[type="date"] { padding: 6px; margin: 0 8px; }
    button.filter-btn { padding: 6px 16px; background: #17a2b8; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    .filter-btn:hover { background: #138496; }
    table { width: 100%; border-collapse: collapse; background: #fff; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background: #007bff; color: white; }
    .details { background: #eef; display: none; }
    .summary { margin: 10px 0; font-size: 18px; background: #e0f7e9; padding: 10px; border-radius: 5px; text-align: center; }
    button.details-btn { padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
  </style>
</head>
<body>

<h1>ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø­Ø³Ø¨ Ø§Ù„ÙØªØ±Ø©</h1>

<div class="controls">
  Ù…Ù†: <input type="date" id="fromDate" />  
  Ø¥Ù„Ù‰: <input type="date" id="toDate" />  
  <button class="filter-btn" onclick="applyFilter()">Ø§Ø¹Ø±Ø¶</button>
</div>

<div class="summary" id="rangeSummary">Ø±Ø¬Ø§Ø¡Ù‹ Ø§Ø®ØªØ± ÙØªØ±Ø©...</div>

<table id="profitsTable">
  <thead>
    <tr>
      <th>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
      <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</th>
      <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­ (Ø¯Ø¬)</th>
      <th>ğŸ“Œ ØªÙØ§ØµÙŠÙ„</th>
    </tr>
  </thead>
  <tbody id="profitsBody"></tbody>
</table>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const app = initializeApp({
    apiKey: "...",
    authDomain: "topclim-3edfa.firebaseapp.com",
    projectId: "topclim-3edfa"
  });
  const db = getFirestore(app);

  const fromEl = document.getElementById("fromDate");
  const toEl = document.getElementById("toDate");
  const summaryEl = document.getElementById("rangeSummary");
  const bodyEl = document.getElementById("profitsBody");

  window.applyFilter = async function() {
    const from = fromEl.value;
    const to = toEl.value;
    if (!from || !to) { alert("â— ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ÙØªØ±Ø© ØµØ­ÙŠØ­Ø©."); return; }
    if (from > to) { alert("â— ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‚Ø¨Ù„ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©."); return; }

    const snap = await getDocs(collection(db, "requests"));
    const grouped = {};
    let total = 0;
    snap.docs.forEach(d => {
      const r = d.data();
      if (r.status !== "ØªÙ… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²") return;
      const conf = r.ownerConfirmation;
      if (!conf?.price) return;
      const dtSec = r.executionSchedule?.seconds || r.createdAt?.seconds;
      if (!dtSec) return;
      const dt = new Date(dtSec * 1000);
      const str = dt.toISOString().split("T")[0];
      if (str < from || str > to) return;

      if (!grouped[str]) grouped[str] = { sum: 0, list: [] };
      grouped[str].sum += conf.price;
      total += conf.price;
      grouped[str].list.push({
        name: r.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…",
        addr: r.address || "",
        price: conf.price,
        indoor: conf.indoor || 0,
        outdoor: conf.outdoor || 0,
        maintenance: conf.maintenance || 0,
        phone: r.phone || ""
      });
    });

    bodyEl.innerHTML = "";
    summaryEl.textContent = `ğŸ§¾ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ù…Ù† ${from} Ø¥Ù„Ù‰ ${to}: ${total.toLocaleString()} Ø¯Ø¬`;

    Object.entries(grouped).sort().forEach(([date, grp]) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${date}</td>
        <td>${grp.list.length}</td>
        <td>${grp.sum.toLocaleString()}</td>
        <td><button class="details-btn" onclick="toggle(event)">Ø¹Ø±Ø¶</button></td>
      `;
      bodyEl.appendChild(tr);
      const dt = document.createElement("tr");
      dt.className = "details";
      dt.innerHTML = `
        <td colspan="4">
          <table style="width:100%;background:#f9f9f9">
            <tr><th>ğŸ‘¤ Ø²Ø¨ÙˆÙ†</th><th>ğŸ“ Ø¹Ù†ÙˆØ§Ù†</th><th>Ø¯Ø§Ø®Ù„ÙŠ</th><th>Ø®Ø§Ø±Ø¬ÙŠ</th><th>ØµÙŠØ§Ù†Ø©</th><th>ğŸ“ Ù‡Ø§ØªÙ</th><th>ğŸ’µ Ø³Ø¹Ø±</th></tr>
            ${grp.list.map(e=>`
              <tr>
                <td>${e.name}</td><td>${e.addr}</td><td>${e.indoor}</td><td>${e.outdoor}</td><td>${e.maintenance}</td><td>${e.phone}</td><td>${e.price.toLocaleString()}</td>
              </tr>`).join("")}
          </table>
        </td>`;
      bodyEl.appendChild(dt);
    });
  };

  window.toggle = function(e) {
    const dt = e.target.closest("tr").nextElementSibling;
    dt.style.display = dt.style.display === "table-row" ? "none" : "table-row";
  };
</script>

</body>
</html>
