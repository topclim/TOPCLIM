<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ“‹ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ â€“ TopClim</title>
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background-color: #f9f9f9;
      margin: 0;
      padding: 20px;
      direction: rtl;
    }

    .container {
      max-width: 700px;
      margin: auto;
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    h2 {
      text-align: center;
      color: #007BFF;
      margin-bottom: 25px;
    }

    .section {
      margin-bottom: 20px;
    }

    .section label {
      font-weight: bold;
      display: block;
      margin-bottom: 8px;
      color: #333;
    }

    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
      background-color: #fdfdfd;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    input[type="file"] {
      margin-top: 10px;
    }

    button {
      background-color: #28a745;
      color: white;
      padding: 12px 20px;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #218838;
    }

    #smallToolsContainer,
    #largeToolsContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .tool-item {
      background-color: #eef2f7;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .tool-item input[type="checkbox"] {
      transform: scale(1.2);
    }

    img#previewImage {
      margin-top: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      max-width: 100%;
    }

    /* Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© */
    .previous-works {
      background: #f0f8ff;
      border: 1px solid #a0c4ff;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .previous-works h3 {
      margin-top: 0;
      color: #007BFF;
      font-size: 1.2rem;
    }
    .previous-works .work-entry {
      border-bottom: 1px solid #d0e2ff;
      padding: 8px 0;
    }
    .previous-works .work-entry:last-child {
      border-bottom: none;
    }
    .previous-works .work-date {
      font-weight: bold;
      margin-bottom: 5px;
      color: #333;
    }

    /* Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø£Ø®Ø·Ø§Ø¡ Ø£Ùˆ Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª */
    #statusMessage {
      margin: 15px 0;
      padding: 12px;
      border-radius: 6px;
      display: none;
      font-weight: bold;
      text-align: center;
    }
    #statusMessage.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    #statusMessage.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
  </style>
</head>
<body>

<div class="container">
  <h2>ğŸ“‹ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„</h2>

  <!-- Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© -->
  <div class="section previous-works" id="previousWorksContainer">
    <h3>ğŸ“… Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>
    <p>â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©...</p>
  </div>

  <div class="section">
    <label>ğŸ§Š Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙƒÙŠÙØ§Øª:</label>
    <input type="number" id="indoorCount" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙƒÙŠÙØ§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©" />
    <input type="number" id="outdoorCount" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙƒÙŠÙØ§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©" />
    <input type="number" id="maintenanceCount" placeholder="Ø¹Ø¯Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©" />
  </div>

  <div class="section">
    <label>ğŸ‘·â€â™‚ï¸ ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ù…Ù„:</label>
    <select id="adminSelector"><option>â³ ØªØ­Ù…ÙŠÙ„...</option></select>
  </div>

  <div class="section">
    <label>ğŸ§° Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØµØºÙŠØ±Ø©:</label>
    <div id="smallToolsContainer"><p>â³ ØªØ­Ù…ÙŠÙ„...</p></div>
  </div>

  <div class="section">
    <label>ğŸ“¦ Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©:</label>
    <div id="largeToolsContainer"><p>â³ ØªØ­Ù…ÙŠÙ„...</p></div>
  </div>

  <div class="section">
    <button type="button" onclick="selectAllTools()">ğŸ“Œ ØªØ­Ø¯ÙŠØ¯ ÙƒÙ„ Ø§Ù„Ø£Ø¯ÙˆØ§Øª</button>
  </div>

  <div class="section">
    <label>ğŸ“· ØµÙˆØ±Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²:</label>
    <input type="file" id="finishImage" accept="image/*" />
    <img id="previewImage" style="display:none;" />
  </div>

  <div class="section">
    <label>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø© (ØªØ¸Ù‡Ø± Ù„Ù„Ø²Ø¨ÙˆÙ†):</label>
    <textarea id="publicNotes" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©..."></textarea>
  </div>

  <div class="section">
    <label>ğŸ“Œ ÙØ±ØµØ© (Ù…ÙƒÙŠÙ Ù„Ù„Ø¨ÙŠØ¹ Ø£Ùˆ Ø·Ù„Ø¨ Ø®Ø§Øµ):</label>
    <textarea id="opportunityNote" placeholder="Ø£Ø¯Ø®Ù„ ÙˆØµÙ Ø§Ù„ÙØ±ØµØ©..."></textarea>
  </div>

  <div class="section">
    <label>ğŸ”’ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®Ø§ØµØ© (Ù„Ø§ ØªØ¸Ù‡Ø± Ù„Ù„Ø²Ø¨ÙˆÙ†):</label>
    <textarea id="privateNotes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙÙ‚Ø·..."></textarea>
  </div>

  <div class="section">
    <button id="finishBtn">âœ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„</button>
  </div>

  <div id="statusMessage"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getFirestore, doc, getDoc, updateDoc,
    collection, getDocs, addDoc
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBjbzbSd1XM9eyXrgKaVj6xnZgIJuQmbRI",
    authDomain: "topclim-3edfa.firebaseapp.com",
    projectId: "topclim-3edfa"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const params = new URLSearchParams(window.location.search);
  const requestId = params.get("id");

  let toolsSmall = [];
  let toolsLarge = [];
  let admins = [];

  // Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­ÙˆÙŠÙ„ ØªØ§Ø±ÙŠØ® Ø¥Ù„Ù‰ Ù†Øµ Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© (Ù…Ø«Ù„Ø§Ù‹ "Ø§Ù„ÙŠÙˆÙ…", "Ø£Ù…Ø³", "Ù‚Ø¨Ù„ Ø£Ù…Ø³", Ø£Ùˆ ØªØ§Ø±ÙŠØ®)
  function formatDateLabel(date) {
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(today.getDate() - 1);
    const dayBeforeYesterday = new Date(today);
    dayBeforeYesterday.setDate(today.getDate() - 2);

    // ØªÙˆØ­ÙŠØ¯ Ø§Ù„ÙˆÙ‚Øª Ø¥Ù„Ù‰ Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„ Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø© ÙÙ‚Ø· Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®
    function toMidnight(d) {
      return new Date(d.getFullYear(), d.getMonth(), d.getDate());
    }

    const dMid = toMidnight(date);
    if (dMid.getTime() === toMidnight(today).getTime()) return "Ø§Ù„ÙŠÙˆÙ…";
    if (dMid.getTime() === toMidnight(yesterday).getTime()) return "Ø£Ù…Ø³";
    if (dMid.getTime() === toMidnight(dayBeforeYesterday).getTime()) return "Ù‚Ø¨Ù„ Ø£Ù…Ø³";

    return date.toLocaleDateString("ar-EG");
  }

  async function loadPreviousWork() {
  try {
    const requestRef = doc(db, "requests", requestId);
    const requestSnap = await getDoc(requestRef);

    if (!requestSnap.exists()) {
      console.error("ğŸ”´ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨");
      return;
    }

    const requestData = requestSnap.data();
    const workDoneArray = Array.isArray(requestData.workDone) ? requestData.workDone : [];

    if (workDoneArray.length === 0) return;

    // ğŸ§® Ù†Ø¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    let totalIndoor = 0, totalOutdoor = 0, totalMaintenance = 0;

    workDoneArray.forEach(work => {
      totalIndoor += work.indoor || 0;
      totalOutdoor += work.outdoor || 0;
      totalMaintenance += work.maintenance || 0;
    });

    // ğŸ“ Ù†Ù…Ù„Ø£ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    document.getElementById("indoorCount").value = totalIndoor;
    document.getElementById("outdoorCount").value = totalOutdoor;
    document.getElementById("maintenanceCount").value = totalMaintenance;

    console.log("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©");
  } catch (error) {
    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©:", error);
  }
}

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØµØºÙŠØ±Ø© ÙˆØ§Ù„ÙƒØ¨ÙŠØ±Ø© ÙˆØ¹Ø±Ø¶Ù‡Ø§
  async function loadTools() {
    try {
      const smallSnap = await getDocs(collection(db, "smallTools"));
      const largeSnap = await getDocs(collection(db, "bigTools"));

      const smallContainer = document.getElementById("smallToolsContainer");
      const largeContainer = document.getElementById("largeToolsContainer");

      smallContainer.innerHTML = "";
      largeContainer.innerHTML = "";

      toolsSmall = [];
      toolsLarge = [];

      smallSnap.forEach(doc => {
        const tool = doc.data().name;
        toolsSmall.push(tool);
        const div = document.createElement("div");
        div.className = "tool-item";
        div.innerHTML = `<input type="checkbox" value="${tool}" /> ${tool}`;
        smallContainer.appendChild(div);
      });

      largeSnap.forEach(doc => {
        const tool = doc.data().name;
        toolsLarge.push(tool);
        const div = document.createElement("div");
        div.className = "tool-item";
        div.innerHTML = `<input type="checkbox" value="${tool}" /> ${tool}`;
        largeContainer.appendChild(div);
      });
    } catch (e) {
      console.error("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¯ÙˆØ§Øª:", e);
      showStatus("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¯ÙˆØ§Øª", "error");
    }
  }

  // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¯Ù…Ù†Ø²
  async function loadAdmins() {
    const adminSelect = document.getElementById("adminSelector");
    adminSelect.innerHTML = "<option disabled selected>Ø§Ø®ØªØ± ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ù…Ù„</option>";

    try {
      const adminSnap = await getDocs(collection(db, "admins"));
      admins = [];
      adminSnap.forEach(docSnap => {
        const admin = docSnap.data();
        admins.push({ id: docSnap.id, ...admin });
        const option = document.createElement("option");
        option.value = docSnap.id;
        option.textContent = `${admin.name} (${admin.phone})`;
        adminSelect.appendChild(option);
      });
    } catch (e) {
      console.error("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¯Ù…Ù†Ø²:", e);
      showStatus("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¯Ù…Ù†Ø²", "error");
    }
  }

  // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¹Ù„Ù‰ Cloudinary
  async function uploadImageToCloudinary(file) {
    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", "topclim_upload");
    formData.append("folder", "WorkerPhotos");

    const res = await fetch("https://api.cloudinary.com/v1_1/dtrmfg2om/image/upload", {
      method: "POST",
      body: formData
    });

    const data = await res.json();
    if (!data.secure_url) throw new Error("ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©");
    return data.secure_url;
  }

  // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø­Ø§Ù„Ø© Ù†Ø§Ø¬Ø­Ø© Ø£Ùˆ Ø®Ø·Ø£
  function showStatus(message, type = "success") {
    const status = document.getElementById("statusMessage");
    status.textContent = message;
    status.className = type === "error" ? "error" : "success";
    status.style.display = "block";
    setTimeout(() => {
      status.style.display = "none";
    }, 6000);
  }

  // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
  async function loadRequestData() {
    if (!requestId) {
      showStatus("âŒ Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.", "error");
      return;
    }
    try {
      const requestRef = doc(db, "requests", requestId);
      const requestSnap = await getDoc(requestRef);
      if (!requestSnap.exists()) {
        showStatus("âŒ Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.", "error");
        return;
      }

      const requestData = requestSnap.data();

      // Ù…Ù„Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ÙÙŠ Ù‚Ø³Ù… "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©"
      const previousWorksContainer = document.getElementById("previousWorksContainer");
      previousWorksContainer.innerHTML = "<h3>ğŸ“… Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>";

      const workDoneArray = Array.isArray(requestData.workDone) ? requestData.workDone : [];

      if (workDoneArray.length === 0) {
        previousWorksContainer.innerHTML += "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¹Ù…Ø§Ù„ Ø³Ø§Ø¨Ù‚Ø©.</p>";
      } else {
        // ÙØ±Ø² Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® ØªÙ†Ø§Ø²Ù„ÙŠØ§Ù‹ (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
        workDoneArray.sort((a, b) => new Date(b.finishedAt) - new Date(a.finishedAt));

        // Ù†Ø¹Ø±Ø¶ Ø¢Ø®Ø± 5 Ø£ÙŠØ§Ù… Ø¹Ù…Ù„ ÙÙ‚Ø· (ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ù‚Ù…)
        const recentWorks = workDoneArray.slice(0, 5);

        recentWorks.forEach(work => {
          const div = document.createElement("div");
          div.className = "work-entry";

          const dateLabel = formatDateLabel(new Date(work.finishedAt));
          div.innerHTML = `
            <div class="work-date">${dateLabel}</div>
            <div>ğŸ§Š Ø¯Ø§Ø®Ù„ÙŠ: <input type="number" class="prev-indoor" value="${work.indoor}" data-id="${work.finishedAt}" /></div>
            <div>ğŸ§Š Ø®Ø§Ø±Ø¬ÙŠ: <input type="number" class="prev-outdoor" value="${work.outdoor}" data-id="${work.finishedAt}" /></div>
            <div>ğŸ”§ ØµÙŠØ§Ù†Ø©: <input type="number" class="prev-maintenance" value="${work.maintenance}" data-id="${work.finishedAt}" /></div>
            <div>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª: <textarea class="prev-publicNotes" data-id="${work.finishedAt}">${work.publicNotes || ''}</textarea></div>
            <hr>
          `;
          previousWorksContainer.appendChild(div);
        });

        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙŠ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ÙŠÙˆÙ… Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ø¹Ù…Ù„ (Ø§Ù„ÙŠÙˆÙ… Ø£Ùˆ Ø¢Ø®Ø± Ø¹Ù…Ù„)
        if (recentWorks.length > 0) {
          const latest = recentWorks[0];
          document.getElementById("indoorCount").value = latest.indoor || 0;
          document.getElementById("outdoorCount").value = latest.outdoor || 0;
          document.getElementById("maintenanceCount").value = latest.maintenance || 0;
          document.getElementById("publicNotes").value = latest.publicNotes || "";
          document.getElementById("opportunityNote").value = latest.opportunityNote || "";
          document.getElementById("privateNotes").value = latest.privateNotes || "";

          // Ø¶Ø¨Ø· Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ù…Ø®ØªØ§Ø± Ø­Ø³Ø¨ Ø¢Ø®Ø± Ø¹Ù…Ù„
          if (latest.adminId) {
            document.getElementById("adminSelector").value = latest.adminId;
          }
        }
      }
    } catch (e) {
      console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨:", e);
      showStatus("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨", "error");
    }
  }

  // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù…Ù„ Ø³Ø§Ø¨Ù‚ Ø¨Ø¹Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù„ÙŠÙ‡Ø§
  async function updatePreviousWork(finishedAtStr, updatedData) {
    try {
      const requestRef = doc(db, "requests", requestId);
      const requestSnap = await getDoc(requestRef);
      if (!requestSnap.exists()) return;

      const requestData = requestSnap.data();
      let workDoneArray = Array.isArray(requestData.workDone) ? requestData.workDone : [];

      // Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø°ÙŠ Ù†Ø±ÙŠØ¯ ØªØ­Ø¯ÙŠØ«Ù‡ Ø¹Ø¨Ø± timestamp
      let idx = workDoneArray.findIndex(w => new Date(w.finishedAt).getTime() === new Date(finishedAtStr).getTime());
      if (idx === -1) return;

      // Ø¯Ù…Ø¬ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
      workDoneArray[idx] = {...workDoneArray[idx], ...updatedData};

      await updateDoc(requestRef, { workDone: workDoneArray });
      showStatus("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚");
    } catch (e) {
      console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚:", e);
      showStatus("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚", "error");
    }
  }

  // Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ÙˆØ±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
  function setupPreviousWorksListeners() {
    const container = document.getElementById("previousWorksContainer");

    // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø£ÙŠ Ù‚ÙŠÙ…Ø© ÙÙŠ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ ÙÙˆØ±Ø§Ù‹ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    container.addEventListener("change", async (ev) => {
      const target = ev.target;
      if (!target) return;

      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ id Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…Ù„ Ù…Ù† data-id
      const id = target.getAttribute("data-id");
      if (!id) return;

      let updatedData = {};

      if (target.classList.contains("prev-indoor")) {
        updatedData.indoor = parseInt(target.value) || 0;
      } else if (target.classList.contains("prev-outdoor")) {
        updatedData.outdoor = parseInt(target.value) || 0;
      } else if (target.classList.contains("prev-maintenance")) {
        updatedData.maintenance = parseInt(target.value) || 0;
      } else if (target.classList.contains("prev-publicNotes")) {
        updatedData.publicNotes = target.value;
      } else {
        return;
      }

      await updatePreviousWork(id, updatedData);
    });
  }

  document.getElementById("finishBtn").addEventListener("click", async () => {
    const indoor = parseInt(document.getElementById("indoorCount").value) || 0;
    const outdoor = parseInt(document.getElementById("outdoorCount").value) || 0;
    const maintenance = parseInt(document.getElementById("maintenanceCount").value) || 0;
    const publicNotes = document.getElementById("publicNotes").value;
    const privateNotes = document.getElementById("privateNotes").value;
    const opportunityNote = document.getElementById("opportunityNote").value;
    const imageFile = document.getElementById("finishImage").files[0];
    const adminId = document.getElementById("adminSelector").value;

    const selectedSmall = Array.from(document.querySelectorAll("#smallToolsContainer input:checked")).map(el => el.value);
    const selectedLarge = Array.from(document.querySelectorAll("#largeToolsContainer input:checked")).map(el => el.value);

    const missingSmall = toolsSmall.filter(tool => !selectedSmall.includes(tool));
    const missingLarge = toolsLarge.filter(tool => !selectedLarge.includes(tool));

    try {
      let imageUrl = "";
      if (imageFile) {
        imageUrl = await uploadImageToCloudinary(imageFile);
        document.getElementById("previewImage").src = imageUrl;
        document.getElementById("previewImage").style.display = "block";
      }

      const requestRef = doc(db, "requests", requestId);
      const requestSnap = await getDoc(requestRef);
      if (!requestSnap.exists()) {
        showStatus("âŒ Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯", "error");
        return;
      }
      const requestData = requestSnap.data();
      let existingWorkDone = Array.isArray(requestData.workDone) ? requestData.workDone : [];

      // Ù†ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¹Ù…Ù„ Ù„Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ… Ù„ØªØ­Ø¯ÙŠØ«Ù‡ Ø¨Ø¯Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      const todayStr = new Date().toDateString();
      const todayIndex = existingWorkDone.findIndex(w => new Date(w.finishedAt).toDateString() === todayStr);

      const todayWork = {
        indoor,
        outdoor,
        maintenance,
        publicNotes,
        privateNotes,
        opportunityNote,
        photo: imageUrl || (todayIndex !== -1 ? existingWorkDone[todayIndex].photo : ""),
        toolsUsed: {
          small: selectedSmall,
          large: selectedLarge
        },
        missingTools: {
          small: missingSmall,
          large: missingLarge
        },
        finishedAt: new Date(),
        adminId: adminId || null
      };

      if (todayIndex !== -1) {
        // ØªØ­Ø¯ÙŠØ« Ø¹Ù…Ù„ Ø§Ù„ÙŠÙˆÙ…
        existingWorkDone[todayIndex] = todayWork;
      } else {
        // Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ Ø¬Ø¯ÙŠØ¯
        existingWorkDone.unshift(todayWork);
      }

      await updateDoc(requestRef, {
        status: "ØªÙ… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²",
        workDone: existingWorkDone
      });

      if (missingSmall.length > 0 || missingLarge.length > 0) {
        await addDoc(collection(db, "alerts"), {
          requestId,
          missingSmall,
          missingLarge,
          timestamp: new Date()
        });
        showStatus("âš ï¸ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¨ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø£Ø¯ÙˆØ§Øª!");
      }

      showStatus("âœ… ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­");

      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
      await loadRequestData();

      // Ù…Ø³Ø­ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
      document.getElementById("finishImage").value = "";
    } catch (e) {
      console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„:", e);
      showStatus("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„", "error");
    }
  });

  window.selectAllTools = function () {
    const allCheckboxes = document.querySelectorAll('#smallToolsContainer input[type="checkbox"], #largeToolsContainer input[type="checkbox"]');
    allCheckboxes.forEach(cb => cb.checked = true);
  }

  // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
  (async () => {
    await loadTools();
    await loadAdmins();
    await loadRequestData();
    await loadPreviousWork(); // â¬…ï¸ Ø£Ø¶Ù Ù‡Ø°Ø§
    setupPreviousWorksListeners();
  })();

</script>
</body>
</html>
