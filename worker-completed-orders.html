<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>📊 تقارير الأعمال المنجزة</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: 'Cairo'; background: #f5f5f5; padding:20px }
    table { width:100%; border-collapse:collapse; background:white; margin-top:20px }
    th, td { border:1px solid #ddd; padding:8px; text-align:center }
    th { background:#007bff; color:#fff }
    input.number, input.date { width:100px; padding:4px }
    .prices { display:flex; gap:10px; margin-bottom:10px }
  </style>
</head>
<body>

<h2>📊 جدول الأعمال المنجزة</h2>

<div class="prices">
  داخلي: <input class="number" id="priceIndoor" type="number" /> |
  خارجي: <input class="number" id="priceOutdoor" type="number" /> |
  صيانة: <input class="number" id="priceMaintenance" type="number" />
</div>

<table>
  <thead>
    <tr>
      <th>📅 من</th><th>📅 إلى</th><th>❄ داخلي</th><th>🌬 خارجي</th><th>🔧 صيانة</th><th>💰 أرباح</th>
    </tr>
  </thead>
  <tbody id="reportTable">
    <tr><td colspan="6">⏳ جاري التحميل...</td></tr>
  </tbody>
</table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "...",
  authDomain: "topclim-3edfa.firebaseapp.com",
  projectId: "topclim-3edfa"
});
const db = getFirestore(app);

const pIndoor = document.getElementById("priceIndoor");
const pOutdoor = document.getElementById("priceOutdoor");
const pMaintenance = document.getElementById("priceMaintenance");
const table = document.getElementById("reportTable");

// استرجاع الأسعار من localStorage
[pIndoor, pOutdoor, pMaintenance].forEach(inp => {
  inp.value = localStorage.getItem(inp.id) || "";
  inp.addEventListener("input", () => {
    localStorage.setItem(inp.id, inp.value);
    loadData();
  });
});

async function loadData() {
  const snap = await getDocs(collection(db, "requests"));
  table.innerHTML = "";
  
  snap.forEach(docSnap => {
    const d = docSnap.data();
    if (d.status !== "تم الإنجاز" || !d.workDone) return;
    
    const w = d.workDone;
    const indoor = w.indoor || 0;
    const outdoor = w.outdoor || 0;
    const maintenance = w.maintenance || 0;

    const from = d.startedAt?.toDate?.().toISOString().split("T")[0] || "";
    const to = w.finishedAt?.toDate?.().toISOString().split("T")[0] || "";

    const total = indoor*(+pIndoor.value || 0)
                + outdoor*(+pOutdoor.value || 0)
                + maintenance*(+pMaintenance.value || 0);

    const row = document.createElement("tr");
    row.innerHTML = `
      <td><input class="date" type="date" value="${from}" onchange="updDate('${docSnap.id}','startedAt',this.value)"></td>
      <td><input class="date" type="date" value="${to}" onchange="updDate('${docSnap.id}','finishedAt',this.value)"></td>
      <td>${indoor}</td><td>${outdoor}</td><td>${maintenance}</td>
      <td>${total.toLocaleString()} د.ج</td>
    `;
    table.appendChild(row);
  });
}

// تحديث التواريخ في قاعدة البيانات
window.updDate = async (id, field, val) => {
  const ref = doc(db, "requests", id);
  const obj = {};
  if (field === "startedAt") obj["startedAt"] = new Date(val);
  else {
    obj["workDone.finishedAt"] = new Date(val);
  }
  await updateDoc(ref, obj);
  alert("تم التعديل ✅");
};

loadData();

</script>

</body>
</html>
