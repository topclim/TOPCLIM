<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>📊 سجل الأعمال - ملخص ربحي</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: #f4f6f9;
      padding: 20px;
      direction: rtl;
      color: #333;
    }
    h2 {
      text-align: center;
      color: #007bff;
    }
    .worker-info {
      text-align: center;
      margin-top: 5px;
      margin-bottom: 15px;
      font-size: 18px;
    }
    #addBtn {
      margin: 10px auto;
      display: block;
      padding: 10px 20px;
      background: #28a745;
      color: #fff;
      border: none;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      margin-top: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    th {
      background: #007bff;
      color: #fff;
    }
    input[type="date"], input[type="number"] {
      width: 100%;
      padding: 6px;
      box-sizing: border-box;
    }
    .deleteBtn {
      cursor: pointer;
      color: #dc3545;
      font-size: 18px;
    }
    .summary {
      margin-top: 20px;
      padding: 10px;
      background: #ffeeba;
      border-radius: 4px;
    }
  </style>
</head>
<body>

  <h2>📊 سجل الأعمال للموظف</h2>
  <div class="worker-info" id="workerDisplay">✅ يتم جلب اسم الموظف...</div>
  <button id="addBtn">＋ إضافة صف جديد</button>

  <table id="mainTable">
    <thead>
      <tr>
        <th>م</th>
        <th>من تاريخ</th>
        <th>إلى تاريخ</th>
        <th>سعر داخلي</th>
        <th>سعر خارجي</th>
        <th>سعر صيانة</th>
        <th>💰 الربح</th>
        <th>🔧 حذف</th>
      </tr>
    </thead>
    <tbody id="tableBody">
      <!-- تُعرض هنا الصفوف -->
    </tbody>
  </table>

  <div class="summary" id="totalSummary">المجموع الكلي: 0 دج</div>

  <script type="module">
    // استيراد Firebase SDK v10
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore,
      collection, getDocs,
      doc, getDoc,
      addDoc, updateDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // إعداد Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBjbzbSd1XM9eyXrgKaVj6xnZgIJuQmbRI",
      authDomain: "topclim-3edfa.firebaseapp.com",
      projectId: "topclim-3edfa"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // جمع معلومات DOM
    const workerDisplay = document.getElementById("workerDisplay");
    const addBtn = document.getElementById("addBtn");
    const tableBody = document.getElementById("tableBody");
    const totalSummary = document.getElementById("totalSummary");

    // استخراج workerId من الرابط
    const workerId = new URLSearchParams(window.location.search).get("workerId");
    if (!workerId) {
      alert("❌ مطلوب workerId في الرابط!");
      throw new Error("workerId missing");
    }

    let totalProfitAll = 0;

    // جلب اسم العامل من Firestore
    async function loadWorkerName() {
      try {
        const snap = await getDoc(doc(db, "workers", workerId));
        if (snap.exists()) {
          const name = snap.data().name || "غير معروف";
          workerDisplay.textContent = `👷 الموظف: ${name}`;
        } else {
          workerDisplay.textContent = "❌ العامل غير موجود";
        }
      } catch (e) {
        console.error(e);
        workerDisplay.textContent = "⚠️ خطأ أثناء جلب اسم العامل";
      }
    }

    // حساب الربح حسب فترة وأسعار
    function computeProfit(row) {
      const d1 = new Date(row.start);
      const d2 = new Date(row.end);
      const days = (d2 - d1) / (1000*3600*24) + 1;
      const sumPerDay = (row.priceIndoor + row.priceOutdoor + row.priceMaintenance);
      return Math.max(0, days * sumPerDay);
    }

    // تحديث الملخص الكلي
    function updateTotal() {
      const rows = tableBody.querySelectorAll("tr");
      totalProfitAll = 0;
      rows.forEach(tr => {
        const cell = tr.cells[6];
        const value = Number(cell.textContent.replace(/[^\d]/g, "")) || 0;
        totalProfitAll += value;
      });
      totalSummary.textContent = `المجموع الكلي: ${totalProfitAll.toLocaleString()} دج`;
    }

    // إعداد صف جديد أو المحفوظ
    function appendRow(id, data) {
      const tr = document.createElement("tr");
      tr.dataset.id = id;

      tr.innerHTML = `
        <td>${tableBody.children.length + 1}</td>
        <td><input type="date" value="${data.start}" /></td>
        <td><input type="date" value="${data.end}" /></td>
        <td><input type="number" min="0" value="${data.priceIndoor}" /></td>
        <td><input type="number" min="0" value="${data.priceOutdoor}" /></td>
        <td><input type="number" min="0" value="${data.priceMaintenance}" /></td>
        <td><strong>0 دج</strong></td>
        <td><span class="deleteBtn">🗑️</span></td>
      `;

      const inputs = tr.querySelectorAll("input");
      const profitCell = tr.querySelector("strong");
      const deleteBtn = tr.querySelector(".deleteBtn");

      const saveAndRecalc = async () => {
        const newData = {
          start: inputs[0].value,
          end: inputs[1].value,
          priceIndoor: Number(inputs[2].value),
          priceOutdoor: Number(inputs[3].value),
          priceMaintenance: Number(inputs[4].value)
        };
        try {
          await updateDoc(doc(db, "summaries", workerId, "entries", id), newData);
        } catch (e) {
          console.error(e);
        }
        const profit = computeProfit(newData);
        profitCell.textContent = `${profit.toLocaleString()} دج`;
        updateTotal();
      };

      inputs.forEach(i => i.addEventListener("change", saveAndRecalc));

      deleteBtn.addEventListener("click", async () => {
        if (confirm("هل تريد حذف هذا الصف؟")) {
          await deleteDoc(doc(db, "summaries", workerId, "entries", id));
          tr.remove();
          Array.from(tableBody.children).forEach((r, idx) => r.cells[0].textContent = idx + 1);
          updateTotal();
        }
      });

      tableBody.appendChild(tr);
      // حساب أولي
      const initialProfit = computeProfit(data);
      profitCell.textContent = `${initialProfit.toLocaleString()} دج`;
      updateTotal();
    }

    // جلب جميع الصفوف من Firestore
    async function loadRows() {
      try {
        const snap = await getDocs(collection(db, "summaries", workerId, "entries"));
        tableBody.innerHTML = "";
        snap.forEach(docSnap => {
          appendRow(docSnap.id, docSnap.data());
        });
      } catch (e) {
        console.error(e);
      }
    }

    // إضافة صف جديد افتراضي
    addBtn.addEventListener("click", async () => {
      const today = new Date().toISOString().split("T")[0];
      const data = {
        start: today,
        end: today,
        priceIndoor: 0,
        priceOutdoor: 0,
        priceMaintenance: 0
      };
      const docRef = await addDoc(collection(db, "summaries", workerId, "entries"), data);
      appendRow(docRef.id, data);
    });

    // عند بدء الصفحة
    (async () => {
      await loadWorkerName();
      await loadRows();
    })();

  </script>

</body>
</html>
