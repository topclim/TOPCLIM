<!DOCTYPE html>
<html lang="ar" dir="rtl">
   <head>
  <!-- إعدادات أساسية -->
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- SEO -->
  <title>📋 تفاصيل الطلب | TopClim</title>
  <meta name="description" content="صفحة تفاصيل الطلب لخدمة تنظيف مكيفات TopClim باحترافية وسرعة." />
  <meta name="keywords" content="تنظيف مكيفات, TopClim, صيانة مكيف, خدمات منزلية, الجزائر" />
  <meta name="author" content="TopClim Team" />
  
  <!-- OG Tags (لمشاركة الصفحة في فيسبوك وغيره) -->
  <meta property="og:title" content="📋 تفاصيل الطلب – TopClim" />
  <meta property="og:description" content="تعرف على تفاصيل طلبك مع أفضل خدمات تنظيف المكيفات." />
  <meta property="og:image" content="" id="ogImageMeta" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://topclim.com/order-details.html" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="📋 تفاصيل الطلب – TopClim" />
  <meta name="twitter:description" content="تابع حالة طلبك مع TopClim، خدمات تنظيف احترافية." />
  <meta name="twitter:image" content="" id="twitterImageMeta" />

  <!-- فافيكون -->
  <link rel="icon" href="/assets/favicon.png" type="image/png" />
  <link rel="apple-touch-icon" href="/assets/apple-icon.png" />

  <!-- خطوط Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet" />

  <!-- Bootstrap RTL (اختياري) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />

  <!-- Leaflet CSS للخرائط -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- نمط عام للموقع -->
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      font-family: 'Cairo', 'Tajawal', sans-serif;
      background-color: #f8f9fa;
      color: #333;
      scroll-behavior: smooth;
    }

    h1, h2, h3, h4, h5 {
      font-weight: bold;
      color: #007BFF;
      margin-bottom: 10px;
    }

    .container {
      max-width: 960px;
      margin: 40px auto;
      padding: 20px 25px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

    .info {
      font-size: 16px;
      margin-bottom: 12px;
    }

    .info strong {
      color: #555;
      display: inline-block;
      width: 160px;
    }

    .note-box, .feedback-box {
      background: #f4fdf8;
      padding: 12px;
      border-left: 4px solid #28a745;
      border-radius: 8px;
      margin: 15px 0;
    }

    .feedback-box {
      background: #fff8e1;
      border-left-color: #ffc107;
    }

    img {
      max-width: 100%;
      height: auto;
      border-radius: 10px;
      border: 1px solid #ccc;
      margin-top: 15px;
    }

    #map {
      height: 260px;
      border-radius: 10px;
      margin-top: 25px;
    }

    .actions {
      text-align: center;
      margin-top: 30px;
    }

    .actions a {
      text-decoration: none;
      margin: 6px;
      padding: 10px 20px;
      font-weight: bold;
      border-radius: 8px;
      transition: background-color 0.3s ease;
    }

    .call {
      background-color: #007BFF;
      color: #fff;
    }

    .whatsapp {
      background-color: #25D366;
      color: white;
    }

    .map-btn {
      background-color: #6c757d;
      color: white;
    }

    .modal {
      position: fixed;
      top: 0; right: 0; bottom: 0; left: 0;
      background: rgba(0, 0, 0, 0.4);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }

    .modal-content {
      background: white;
      padding: 25px;
      width: 90%;
      max-width: 420px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }

    .modal-content h3 {
      margin-bottom: 20px;
      color: #007BFF;
    }

    .modal-content label {
      display: block;
      font-weight: bold;
      margin: 10px 0 5px;
    }

    .modal-content input,
    .modal-content select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-bottom: 12px;
    }

    .modal-content button {
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      margin: 5px;
      font-weight: bold;
      cursor: pointer;
    }

    .modal-content button:first-child {
      background: #dc3545;
      color: white;
    }

    .modal-content button:last-child {
      background: #28a745;
      color: white;
    }

    @media (max-width: 768px) {
      .container {
        margin: 20px 10px;
        padding: 20px;
      }

      .info strong {
        width: 120px;
      }

      h2 {
        font-size: 20px;
      }
    }

    .actions {
  display: flex !important;
  flex-wrap: wrap !important;  /* السماح بتقسيم الأزرار إلى أكثر من صف */
  gap: 10px;                  /* مسافة بين الأزرار */
  justify-content: center;    /* توسيط */
}

.actions a {
  flex: 1 1 120px;           /* السماح للزر بأخذ عرض مرن مع حد أدنى */
  text-align: center;
  padding: 12px 20px;
  border-radius: 6px;
  font-weight: bold;
  text-decoration: none;
  white-space: nowrap;       /* منع التفاف النص داخل الزر */
  box-sizing: border-box;
}

  </style>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>



<body>
  <div class="container">
    <h2>📋 تفاصيل الطلب</h2>
    <div id="orderDetails">⏳ جاري تحميل البيانات...</div>

    <!-- صورة المكيف إن وجدت -->
    <div id="imagePreview" style="margin-top:20px;"></div>

    <!-- الخريطة -->
    <div id="map"></div>

    <!-- الروابط الخاصة -->
    <div class="actions" id="actionLinks" style="display:none;"></div>
  </div>

  <!-- نافذة جدولة التنفيذ -->
  <div id="scheduleModal" class="modal">
    <div class="modal-content">
      <h3>📅 جدولة تنفيذ الطلب</h3>
      <label>📆 التاريخ:</label>
      <input type="date" id="execDate" />

      <label>⏰ الوقت:</label>
      <input type="time" id="execTime" />

      <label>👷‍♂️ اسم المساعد:</label>
      <select id="assistantSelect"></select>

      <label>👑 صاحب العمل:</label>
      <select id="adminSelect"></select>

      <div style="margin-top: 15px; text-align: right;">
        <button onclick="closeModal()">❌ إلغاء</button>
        <button onclick="saveSchedule()">💾 حفظ</button>
      </div>
    </div>
  </div>

  <!-- نافذة الصور النهائية -->
  <div id="workImagesModal" class="modal">
    <div class="modal-content">
      <h3>📸 صور تنفيذ العمل</h3>
      <div id="workImagesContent" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
      <div style="text-align: right; margin-top: 15px;">
        <button onclick="closeWorkImages()">❌ إغلاق</button>
      </div>
    </div>
  </div>

  <!-- نافذة الملاحظات العامة -->
  <div id="publicNotesModal" class="modal">
    <div class="modal-content">
      <h3>🗒️ ملاحظات عامة</h3>
      <textarea id="publicNoteInput" rows="4" placeholder="اكتب ملاحظاتك هنا..." style="width:100%; padding:10px; border-radius:6px;"></textarea>
      <div style="text-align:right; margin-top:10px;">
        <button onclick="closeNoteModal()">❌ إلغاء</button>
        <button onclick="submitPublicNote()">✅ حفظ</button>
      </div>
    </div>
  </div>

  <!-- نافذة تغيير الحالة -->
  <div id="statusModal" class="modal">
    <div class="modal-content">
      <h3>🟢 تغيير حالة الطلب</h3>
      <label>اختر الحالة الجديدة:</label>
      <select id="statusSelect">
        <option value="مبدئي">مبدئي</option>
        <option value="تم الجدولة">تم الجدولة</option>
        <option value="قيد التنفيذ">قيد التنفيذ</option>
        <option value="منجز">منجز</option>
        <option value="ملغي">ملغي</option>
      </select>
      <div style="margin-top: 15px; text-align: right;">
        <button onclick="closeStatusModal()">❌ إلغاء</button>
        <button onclick="updateStatus()">✅ تأكيد</button>
      </div>
    </div>
  </div>

  <!-- تذييل الصفحة -->
  <footer style="text-align:center; padding:20px; color:#777; font-size:14px;">
    جميع الحقوق محفوظة © TopClim 2025
  </footer>

  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore,
  doc,
  getDoc,
  getDocs,
  collection,
  updateDoc,
  Timestamp,
  arrayUnion
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBjbzbSd1XM9eyXrgKaVj6xnZgIJuQmbRI",
  authDomain: "topclim-3edfa.firebaseapp.com",
  projectId: "topclim-3edfa"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const orderId = new URLSearchParams(window.location.search).get("id");
const orderBox = document.getElementById("orderDetails");
const actionBox = document.getElementById("actionLinks");
let selectedOrderRef = null;

async function loadOrder() {
  if (!orderId) return (orderBox.innerHTML = "❌ لم يتم تحديد الطلب.");
  selectedOrderRef = doc(db, "requests", orderId);
  const snap = await getDoc(selectedOrderRef);
  if (!snap.exists()) return (orderBox.innerHTML = "❌ الطلب غير موجود.");

  const d = snap.data();
  let html = `
    <div class="info"><strong>📄 رقم الطلب:</strong> ${orderId}</div>
    <div class="info"><strong>👤 الاسم:</strong> ${d.name || "غير معروف"}</div>
    <div class="info"><strong>📞 الهاتف:</strong> ${d.phone || "غير متوفر"}</div>
    <div class="info"><strong>📍 العنوان:</strong> ${d.address || "غير متوفر"}</div>
    <div class="info"><strong>🕐 الوقت المفضل:</strong> ${d.preferredTime || "-"}</div>
    <div class="info"><strong>📌 الحالة:</strong> ${d.status || "غير معروفة"}</div>
    <div class="info"><strong>❄️ عدد المكيفات:</strong> ${d.acCount || "-"}</div>
  `;

  if (d.notes) {
    html += `<div class="note-box"><strong>📝 ملاحظات:</strong><br>${d.notes}</div>`;
  }

  if (d.acUnits && Array.isArray(d.acUnits)) {
    html += "<hr><h4>📦 تفاصيل المكيفات:</h4>";
    d.acUnits.forEach((ac, i) => {
      html += `<div class="info"><strong>مكيف ${i + 1}:</strong> ${ac.type} - ${ac.size}</div>`;
    });
  }

  orderBox.innerHTML = html;

  // عرض صورة المكيف إن وجدت
  if (d.imageUrl) {
    document.getElementById("imagePreview").innerHTML = `<img src="${d.imageUrl}" alt="صورة المكيف" />`;
  }

  // عرض الخريطة
  if (d.location) {
    const lat = d.location.lat;
    const lng = d.location.lng;
    const map = L.map("map").setView([lat, lng], 15);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap contributors",
    }).addTo(map);
    L.marker([lat, lng]).addTo(map).bindPopup("📍 موقع الزبون").openPopup();
    document.getElementById("map").style.display = "block";
  }

  // روابط الاتصال وزر السر (الدخول المباشر للخريطة)
  if (d.phone) {
    const phoneNo = d.phone.replace(/^0/, "213");
    actionBox.innerHTML = `
      <a class="call" href="tel:${d.phone}">📞 اتصال</a>
      <a class="whatsapp" href="https://wa.me/${phoneNo}" target="_blank">💬 واتساب</a>
      <a class="map-btn" href="#" id="scheduleBtn">🗓️ جدولة التنفيذ</a>
      <a class="map-btn" href="#" id="openMapAppBtn">🗺️ فتح تطبيق الخريطة</a>
    `;
    actionBox.style.display = "flex";
    actionBox.style.flexWrap = "wrap";  // يمنع تداخل الأزرار في الهواتف
  }

  // إضافة مستمعين للأحداث بدلًا من onclick
  document.getElementById("scheduleBtn").addEventListener("click", (e) => {
    e.preventDefault();
    openModal();
  });

  document.getElementById("autoStatusBtn").addEventListener("click", async (e) => {
    e.preventDefault();
    await autoChangeStatus();
  });

  document.getElementById("openMapAppBtn").addEventListener("click", (e) => {
    e.preventDefault();
    openMapApp(d.location);
  });
}

async function loadWorkers() {
  const snap = await getDocs(collection(db, "workers"));
  const select = document.getElementById("assistantSelect");
  select.innerHTML = '<option value="">— اختر المساعد —</option>';
  snap.forEach((doc) => {
    const d = doc.data();
    select.innerHTML += `<option value="${doc.id}">${d.name}</option>`;
  });
}

async function loadAdmins() {
  const snap = await getDocs(collection(db, "admins"));
  const select = document.getElementById("adminSelect");
  select.innerHTML = '<option value="">— اختر صاحب العمل —</option>';
  snap.forEach((doc) => {
    const d = doc.data();
    select.innerHTML += `<option value="${doc.id}">${d.name}</option>`;
  });
}

// حفظ الجدولة مع تغيير الحالة أوتوماتيكياً
async function saveSchedule() {
  const date = document.getElementById("execDate").value;
  const time = document.getElementById("execTime").value;
  const workerId = document.getElementById("assistantSelect").value;
  const adminId = document.getElementById("adminSelect").value;
  const saveBtn = document.querySelector('#scheduleModal button[onclick="saveSchedule()"]');

  if (!date || !time || !workerId || !adminId) {
    alert("❌ يرجى تعبئة جميع الحقول.");
    return;
  }

  saveBtn.disabled = true;
  saveBtn.textContent = "⏳ جاري التحقق...";

  const execDateTime = Timestamp.fromDate(new Date(`${date}T${time}`));
  const snap = await getDoc(selectedOrderRef);
  const existingData = snap.data();
  const existingWork = existingData.workDone || [];

  const isDuplicateDate = existingWork.some(entry => {
    const existingDate = entry.finishedAt?.toDate().toISOString().slice(0, 10);
    const newDate = new Date(`${date}T${time}`).toISOString().slice(0, 10);
    return existingDate === newDate;
  });

  if (isDuplicateDate) {
    const proceed = confirm(
      "⚠️ يوجد بالفعل جدول عمل مسجل في هذا التاريخ.\n\nهل ترغب في إضافة جدول جديد أيضًا في نفس اليوم؟\n\n- اختر 'حسنًا' لـ: ✅ نعم، أضف الجدولة الجديدة\n- اختر 'إلغاء' لـ: ❌ لا، سأغير التاريخ"
    );
    if (!proceed) {
      saveBtn.disabled = false;
      saveBtn.textContent = "💾 حفظ";
      return;
    }
  }

  const workLog = {
    adminId,
    finishedAt: execDateTime,
    indoor: 0,
    outdoor: 0,
    maintenance: 0,
    toolsUsed: { large: [], small: [] },
    missingTools: { large: [], small: [] },
    photo: "",
    opportunityNote: "",
    privateNotes: "",
    publicNotes: ""
  };

  await updateDoc(selectedOrderRef, {
    assignedTo: workerId,
    executionSchedule: execDateTime,
    workDone: arrayUnion(workLog) // ✅ دائمًا نضيف خانة جديدة
  });

  alert("✅ تم إضافة الجدولة بنجاح.");
  closeModal();
  loadOrder();

  saveBtn.disabled = false;
  saveBtn.textContent = "💾 حفظ";
}

// الدالة لتغيير الحالة أوتوماتيكياً (تغير الحالة مثلاً إلى "قيد التنفيذ")
async function autoChangeStatus() {
  if (!selectedOrderRef) return alert("❌ لم يتم تحميل الطلب بعد.");
  try {
    await updateDoc(selectedOrderRef, {
      status: "قيد التنفيذ"
    });
    alert("✅ تم تغيير الحالة إلى 'قيد التنفيذ' تلقائياً.");
    loadOrder();
  } catch (e) {
    alert("❌ فشل في تغيير الحالة: " + e.message);
  }
}

// فتح تطبيق الخريطة مع الإحداثيات مباشرة
function openMapApp(location) {
  if (!location || !location.lat || !location.lng) {
    return alert("❌ لا يوجد موقع محدد للعرض.");
  }
  // رابط Google Maps مع الاحداثيات
  const url = `https://www.google.com/maps/search/?api=1&query=${location.lat},${location.lng}`;
  window.open(url, "_blank");
}

// مودالات
window.openModal = function () {
  document.getElementById("scheduleModal").style.display = "flex";
};
window.closeModal = function () {
  document.getElementById("scheduleModal").style.display = "none";
};

window.openStatusModal = function () {
  document.getElementById("statusModal").style.display = "flex";
};
window.closeStatusModal = function () {
  document.getElementById("statusModal").style.display = "none";
};

window.openNoteModal = function () {
  document.getElementById("publicNotesModal").style.display = "flex";
};
window.closeNoteModal = function () {
  document.getElementById("publicNotesModal").style.display = "none";
};

window.closeWorkImages = function () {
  document.getElementById("workImagesModal").style.display = "none";
};

// تحميل أولي
loadOrder();
loadWorkers();
loadAdmins();

// تعريف دوال في النطاق العام لتفادي الخطأ updateStatus
window.updateStatus = autoChangeStatus;
window.saveSchedule = saveSchedule;
</script>


</body>
</html>