<!DOCTYPE html>
<html lang="ar" dir="rtl">
   <head>
  <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© -->
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- SEO -->
  <title>ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ | TopClim</title>
  <meta name="description" content="ØµÙØ­Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ø®Ø¯Ù…Ø© ØªÙ†Ø¸ÙŠÙ Ù…ÙƒÙŠÙØ§Øª TopClim Ø¨Ø§Ø­ØªØ±Ø§ÙÙŠØ© ÙˆØ³Ø±Ø¹Ø©." />
  <meta name="keywords" content="ØªÙ†Ø¸ÙŠÙ Ù…ÙƒÙŠÙØ§Øª, TopClim, ØµÙŠØ§Ù†Ø© Ù…ÙƒÙŠÙ, Ø®Ø¯Ù…Ø§Øª Ù…Ù†Ø²Ù„ÙŠØ©, Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±" />
  <meta name="author" content="TopClim Team" />
  
  <!-- OG Tags (Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØµÙØ­Ø© ÙÙŠ ÙÙŠØ³Ø¨ÙˆÙƒ ÙˆØºÙŠØ±Ù‡) -->
  <meta property="og:title" content="ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ â€“ TopClim" />
  <meta property="og:description" content="ØªØ¹Ø±Ù Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨Ùƒ Ù…Ø¹ Ø£ÙØ¶Ù„ Ø®Ø¯Ù…Ø§Øª ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙƒÙŠÙØ§Øª." />
  <meta property="og:image" content="" id="ogImageMeta" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://topclim.com/order-details.html" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ â€“ TopClim" />
  <meta name="twitter:description" content="ØªØ§Ø¨Ø¹ Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ùƒ Ù…Ø¹ TopClimØŒ Ø®Ø¯Ù…Ø§Øª ØªÙ†Ø¸ÙŠÙ Ø§Ø­ØªØ±Ø§ÙÙŠØ©." />
  <meta name="twitter:image" content="" id="twitterImageMeta" />

  <!-- ÙØ§ÙÙŠÙƒÙˆÙ† -->
  <link rel="icon" href="/assets/favicon.png" type="image/png" />
  <link rel="apple-touch-icon" href="/assets/apple-icon.png" />

  <!-- Ø®Ø·ÙˆØ· Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet" />

  <!-- Bootstrap RTL (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />

  <!-- Leaflet CSS Ù„Ù„Ø®Ø±Ø§Ø¦Ø· -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Ù†Ù…Ø· Ø¹Ø§Ù… Ù„Ù„Ù…ÙˆÙ‚Ø¹ -->
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      font-family: 'Cairo', 'Tajawal', sans-serif;
      background-color: #f8f9fa;
      color: #333;
      scroll-behavior: smooth;
    }

    h1, h2, h3, h4, h5 {
      font-weight: bold;
      color: #007BFF;
      margin-bottom: 10px;
    }

    .container {
      max-width: 960px;
      margin: 40px auto;
      padding: 20px 25px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

    .info {
      font-size: 16px;
      margin-bottom: 12px;
    }

    .info strong {
      color: #555;
      display: inline-block;
      width: 160px;
    }

    .note-box, .feedback-box {
      background: #f4fdf8;
      padding: 12px;
      border-left: 4px solid #28a745;
      border-radius: 8px;
      margin: 15px 0;
    }

    .feedback-box {
      background: #fff8e1;
      border-left-color: #ffc107;
    }

    img {
      max-width: 100%;
      height: auto;
      border-radius: 10px;
      border: 1px solid #ccc;
      margin-top: 15px;
    }

    #map {
      height: 260px;
      border-radius: 10px;
      margin-top: 25px;
    }

    .actions {
      text-align: center;
      margin-top: 30px;
    }

    .actions a {
      text-decoration: none;
      margin: 6px;
      padding: 10px 20px;
      font-weight: bold;
      border-radius: 8px;
      transition: background-color 0.3s ease;
    }

    .call {
      background-color: #007BFF;
      color: #fff;
    }

    .whatsapp {
      background-color: #25D366;
      color: white;
    }

    .map-btn {
      background-color: #6c757d;
      color: white;
    }

    .modal {
      position: fixed;
      top: 0; right: 0; bottom: 0; left: 0;
      background: rgba(0, 0, 0, 0.4);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }

    .modal-content {
      background: white;
      padding: 25px;
      width: 90%;
      max-width: 420px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }

    .modal-content h3 {
      margin-bottom: 20px;
      color: #007BFF;
    }

    .modal-content label {
      display: block;
      font-weight: bold;
      margin: 10px 0 5px;
    }

    .modal-content input,
    .modal-content select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-bottom: 12px;
    }

    .modal-content button {
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      margin: 5px;
      font-weight: bold;
      cursor: pointer;
    }

    .modal-content button:first-child {
      background: #dc3545;
      color: white;
    }

    .modal-content button:last-child {
      background: #28a745;
      color: white;
    }

    @media (max-width: 768px) {
      .container {
        margin: 20px 10px;
        padding: 20px;
      }

      .info strong {
        width: 120px;
      }

      h2 {
        font-size: 20px;
      }
    }

    .actions {
  display: flex !important;
  flex-wrap: wrap !important;  /* Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¥Ù„Ù‰ Ø£ÙƒØ«Ø± Ù…Ù† ØµÙ */
  gap: 10px;                  /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
  justify-content: center;    /* ØªÙˆØ³ÙŠØ· */
}

.actions a {
  flex: 1 1 120px;           /* Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ø²Ø± Ø¨Ø£Ø®Ø° Ø¹Ø±Ø¶ Ù…Ø±Ù† Ù…Ø¹ Ø­Ø¯ Ø£Ø¯Ù†Ù‰ */
  text-align: center;
  padding: 12px 20px;
  border-radius: 6px;
  font-weight: bold;
  text-decoration: none;
  white-space: nowrap;       /* Ù…Ù†Ø¹ Ø§Ù„ØªÙØ§Ù Ø§Ù„Ù†Øµ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø²Ø± */
  box-sizing: border-box;
}

  </style>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>



<body>
  <div class="container">
    <h2>ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h2>
    <div id="orderDetails">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>

    <!-- ØµÙˆØ±Ø© Ø§Ù„Ù…ÙƒÙŠÙ Ø¥Ù† ÙˆØ¬Ø¯Øª -->
    <div id="imagePreview" style="margin-top:20px;"></div>

    <!-- Ø§Ù„Ø®Ø±ÙŠØ·Ø© -->
    <div id="map"></div>

    <!-- Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø®Ø§ØµØ© -->
    <div class="actions" id="actionLinks" style="display:none;"></div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„ØªÙ†ÙÙŠØ° -->
  <div id="scheduleModal" class="modal">
    <div class="modal-content">
      <h3>ğŸ“… Ø¬Ø¯ÙˆÙ„Ø© ØªÙ†ÙÙŠØ° Ø§Ù„Ø·Ù„Ø¨</h3>
      <label>ğŸ“† Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
      <input type="date" id="execDate" />

      <label>â° Ø§Ù„ÙˆÙ‚Øª:</label>
      <input type="time" id="execTime" />

      <label>ğŸ‘·â€â™‚ï¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯:</label>
      <select id="assistantSelect"></select>

      <label>ğŸ‘‘ ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ù…Ù„:</label>
      <select id="adminSelect"></select>

      <div style="margin-top: 15px; text-align: right;">
        <button onclick="closeModal()">âŒ Ø¥Ù„ØºØ§Ø¡</button>
        <button onclick="saveSchedule()">ğŸ’¾ Ø­ÙØ¸</button>
      </div>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØµÙˆØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© -->
  <div id="workImagesModal" class="modal">
    <div class="modal-content">
      <h3>ğŸ“¸ ØµÙˆØ± ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„</h3>
      <div id="workImagesContent" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
      <div style="text-align: right; margin-top: 15px;">
        <button onclick="closeWorkImages()">âŒ Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© -->
  <div id="publicNotesModal" class="modal">
    <div class="modal-content">
      <h3>ğŸ—’ï¸ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©</h3>
      <textarea id="publicNoteInput" rows="4" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ù‡Ù†Ø§..." style="width:100%; padding:10px; border-radius:6px;"></textarea>
      <div style="text-align:right; margin-top:10px;">
        <button onclick="closeNoteModal()">âŒ Ø¥Ù„ØºØ§Ø¡</button>
        <button onclick="submitPublicNote()">âœ… Ø­ÙØ¸</button>
      </div>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© -->
  <div id="statusModal" class="modal">
    <div class="modal-content">
      <h3>ğŸŸ¢ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</h3>
      <label>Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:</label>
      <select id="statusSelect">
        <option value="Ù…Ø¨Ø¯Ø¦ÙŠ">Ù…Ø¨Ø¯Ø¦ÙŠ</option>
        <option value="ØªÙ… Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©">ØªÙ… Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©</option>
        <option value="Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
        <option value="Ù…Ù†Ø¬Ø²">Ù…Ù†Ø¬Ø²</option>
        <option value="Ù…Ù„ØºÙŠ">Ù…Ù„ØºÙŠ</option>
      </select>
      <div style="margin-top: 15px; text-align: right;">
        <button onclick="closeStatusModal()">âŒ Ø¥Ù„ØºØ§Ø¡</button>
        <button onclick="updateStatus()">âœ… ØªØ£ÙƒÙŠØ¯</button>
      </div>
    </div>
  </div>

  <!-- ØªØ°ÙŠÙŠÙ„ Ø§Ù„ØµÙØ­Ø© -->
  <footer style="text-align:center; padding:20px; color:#777; font-size:14px;">
    Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© TopClim 2025
  </footer>

  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore,
  doc,
  getDoc,
  getDocs,
  collection,
  updateDoc,
  Timestamp,
  arrayUnion
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBjbzbSd1XM9eyXrgKaVj6xnZgIJuQmbRI",
  authDomain: "topclim-3edfa.firebaseapp.com",
  projectId: "topclim-3edfa"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const orderId = new URLSearchParams(window.location.search).get("id");
const orderBox = document.getElementById("orderDetails");
const actionBox = document.getElementById("actionLinks");
let selectedOrderRef = null;

async function loadOrder() {
  if (!orderId) return (orderBox.innerHTML = "âŒ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨.");
  selectedOrderRef = doc(db, "requests", orderId);
  const snap = await getDoc(selectedOrderRef);
  if (!snap.exists()) return (orderBox.innerHTML = "âŒ Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");

  const d = snap.data();
  let html = `
    <div class="info"><strong>ğŸ“„ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</strong> ${orderId}</div>
    <div class="info"><strong>ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…:</strong> ${d.name || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"}</div>
    <div class="info"><strong>ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${d.phone || "ØºÙŠØ± Ù…ØªÙˆÙØ±"}</div>
    <div class="info"><strong>ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${d.address || "ØºÙŠØ± Ù…ØªÙˆÙØ±"}</div>
    <div class="info"><strong>ğŸ• Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ÙØ¶Ù„:</strong> ${d.preferredTime || "-"}</div>
    <div class="info"><strong>ğŸ“Œ Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${d.status || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©"}</div>
    <div class="info"><strong>â„ï¸ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙƒÙŠÙØ§Øª:</strong> ${d.acCount || "-"}</div>
  `;

  if (d.notes) {
    html += `<div class="note-box"><strong>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong><br>${d.notes}</div>`;
  }

  if (d.acUnits && Array.isArray(d.acUnits)) {
    html += "<hr><h4>ğŸ“¦ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙƒÙŠÙØ§Øª:</h4>";
    d.acUnits.forEach((ac, i) => {
      html += `<div class="info"><strong>Ù…ÙƒÙŠÙ ${i + 1}:</strong> ${ac.type} - ${ac.size}</div>`;
    });
  }

  orderBox.innerHTML = html;

  // Ø¹Ø±Ø¶ ØµÙˆØ±Ø© Ø§Ù„Ù…ÙƒÙŠÙ Ø¥Ù† ÙˆØ¬Ø¯Øª
  if (d.imageUrl) {
    document.getElementById("imagePreview").innerHTML = `<img src="${d.imageUrl}" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…ÙƒÙŠÙ" />`;
  }

  // Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
  if (d.location) {
    const lat = d.location.lat;
    const lng = d.location.lng;
    const map = L.map("map").setView([lat, lng], 15);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "Â© OpenStreetMap contributors",
    }).addTo(map);
    L.marker([lat, lng]).addTo(map).bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø²Ø¨ÙˆÙ†").openPopup();
    document.getElementById("map").style.display = "block";
  }

  // Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ²Ø± Ø§Ù„Ø³Ø± (Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø®Ø±ÙŠØ·Ø©)
  if (d.phone) {
    const phoneNo = d.phone.replace(/^0/, "213");
    actionBox.innerHTML = `
      <a class="call" href="tel:${d.phone}">ğŸ“ Ø§ØªØµØ§Ù„</a>
      <a class="whatsapp" href="https://wa.me/${phoneNo}" target="_blank">ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨</a>
      <a class="map-btn" href="#" id="scheduleBtn">ğŸ—“ï¸ Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„ØªÙ†ÙÙŠØ°</a>
      <a class="map-btn" href="#" id="openMapAppBtn">ğŸ—ºï¸ ÙØªØ­ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a>
    `;
    actionBox.style.display = "flex";
    actionBox.style.flexWrap = "wrap";  // ÙŠÙ…Ù†Ø¹ ØªØ¯Ø§Ø®Ù„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ù‡ÙˆØ§ØªÙ
  }

  // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„Ù„Ø£Ø­Ø¯Ø§Ø« Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† onclick
  document.getElementById("scheduleBtn").addEventListener("click", (e) => {
    e.preventDefault();
    openModal();
  });

  document.getElementById("autoStatusBtn").addEventListener("click", async (e) => {
    e.preventDefault();
    await autoChangeStatus();
  });

  document.getElementById("openMapAppBtn").addEventListener("click", (e) => {
    e.preventDefault();
    openMapApp(d.location);
  });
}

async function loadWorkers() {
  const snap = await getDocs(collection(db, "workers"));
  const select = document.getElementById("assistantSelect");
  select.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ â€”</option>';
  snap.forEach((doc) => {
    const d = doc.data();
    select.innerHTML += `<option value="${doc.id}">${d.name}</option>`;
  });
}

async function loadAdmins() {
  const snap = await getDocs(collection(db, "admins"));
  const select = document.getElementById("adminSelect");
  select.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ù…Ù„ â€”</option>';
  snap.forEach((doc) => {
    const d = doc.data();
    select.innerHTML += `<option value="${doc.id}">${d.name}</option>`;
  });
}

// Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© Ù…Ø¹ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒÙŠØ§Ù‹
async function saveSchedule() {
  const date = document.getElementById("execDate").value;
  const time = document.getElementById("execTime").value;
  const workerId = document.getElementById("assistantSelect").value;
  const adminId = document.getElementById("adminSelect").value;
  const saveBtn = document.querySelector('#scheduleModal button[onclick="saveSchedule()"]');

  if (!date || !time || !workerId || !adminId) {
    alert("âŒ ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.");
    return;
  }

  saveBtn.disabled = true;
  saveBtn.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...";

  const execDateTime = Timestamp.fromDate(new Date(`${date}T${time}`));
  const snap = await getDoc(selectedOrderRef);
  const existingData = snap.data();
  const existingWork = existingData.workDone || [];

  const isDuplicateDate = existingWork.some(entry => {
    const existingDate = entry.finishedAt?.toDate().toISOString().slice(0, 10);
    const newDate = new Date(`${date}T${time}`).toISOString().slice(0, 10);
    return existingDate === newDate;
  });

  if (isDuplicateDate) {
    const proceed = confirm(
      "âš ï¸ ÙŠÙˆØ¬Ø¯ Ø¨Ø§Ù„ÙØ¹Ù„ Ø¬Ø¯ÙˆÙ„ Ø¹Ù…Ù„ Ù…Ø³Ø¬Ù„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®.\n\nÙ‡Ù„ ØªØ±ØºØ¨ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙˆÙ„ Ø¬Ø¯ÙŠØ¯ Ø£ÙŠØ¶Ù‹Ø§ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…ØŸ\n\n- Ø§Ø®ØªØ± 'Ø­Ø³Ù†Ù‹Ø§' Ù„Ù€: âœ… Ù†Ø¹Ù…ØŒ Ø£Ø¶Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©\n- Ø§Ø®ØªØ± 'Ø¥Ù„ØºØ§Ø¡' Ù„Ù€: âŒ Ù„Ø§ØŒ Ø³Ø£ØºÙŠØ± Ø§Ù„ØªØ§Ø±ÙŠØ®"
    );
    if (!proceed) {
      saveBtn.disabled = false;
      saveBtn.textContent = "ğŸ’¾ Ø­ÙØ¸";
      return;
    }
  }

  const workLog = {
    adminId,
    finishedAt: execDateTime,
    indoor: 0,
    outdoor: 0,
    maintenance: 0,
    toolsUsed: { large: [], small: [] },
    missingTools: { large: [], small: [] },
    photo: "",
    opportunityNote: "",
    privateNotes: "",
    publicNotes: ""
  };

  await updateDoc(selectedOrderRef, {
    assignedTo: workerId,
    executionSchedule: execDateTime,
    workDone: arrayUnion(workLog) // âœ… Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ù†Ø¶ÙŠÙ Ø®Ø§Ù†Ø© Ø¬Ø¯ÙŠØ¯Ø©
  });

  alert("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© Ø¨Ù†Ø¬Ø§Ø­.");
  closeModal();
  loadOrder();

  saveBtn.disabled = false;
  saveBtn.textContent = "ğŸ’¾ Ø­ÙØ¸";
}

// Ø§Ù„Ø¯Ø§Ù„Ø© Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒÙŠØ§Ù‹ (ØªØºÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ø«Ù„Ø§Ù‹ Ø¥Ù„Ù‰ "Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°")
async function autoChangeStatus() {
  if (!selectedOrderRef) return alert("âŒ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¹Ø¯.");
  try {
    await updateDoc(selectedOrderRef, {
      status: "Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°"
    });
    alert("âœ… ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.");
    loadOrder();
  } catch (e) {
    alert("âŒ ÙØ´Ù„ ÙÙŠ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©: " + e.message);
  }
}

// ÙØªØ­ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ø¹ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù…Ø¨Ø§Ø´Ø±Ø©
function openMapApp(location) {
  if (!location || !location.lat || !location.lng) {
    return alert("âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆÙ‚Ø¹ Ù…Ø­Ø¯Ø¯ Ù„Ù„Ø¹Ø±Ø¶.");
  }
  // Ø±Ø§Ø¨Ø· Google Maps Ù…Ø¹ Ø§Ù„Ø§Ø­Ø¯Ø§Ø«ÙŠØ§Øª
  const url = `https://www.google.com/maps/search/?api=1&query=${location.lat},${location.lng}`;
  window.open(url, "_blank");
}

// Ù…ÙˆØ¯Ø§Ù„Ø§Øª
window.openModal = function () {
  document.getElementById("scheduleModal").style.display = "flex";
};
window.closeModal = function () {
  document.getElementById("scheduleModal").style.display = "none";
};

window.openStatusModal = function () {
  document.getElementById("statusModal").style.display = "flex";
};
window.closeStatusModal = function () {
  document.getElementById("statusModal").style.display = "none";
};

window.openNoteModal = function () {
  document.getElementById("publicNotesModal").style.display = "flex";
};
window.closeNoteModal = function () {
  document.getElementById("publicNotesModal").style.display = "none";
};

window.closeWorkImages = function () {
  document.getElementById("workImagesModal").style.display = "none";
};

// ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ÙŠ
loadOrder();
loadWorkers();
loadAdmins();

// ØªØ¹Ø±ÙŠÙ Ø¯ÙˆØ§Ù„ ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù… Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„Ø®Ø·Ø£ updateStatus
window.updateStatus = autoChangeStatus;
window.saveSchedule = saveSchedule;
</script>


</body>
</html>