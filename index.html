<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ØªÙ†Ø¸ÙŠÙ Ù…ÙƒÙŠÙØ§Øª â€“ TopClim</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { font-family: 'Cairo', sans-serif; background: #f8f9fa; margin: 0; padding: 0; }
    header, footer { color: white; text-align: center; padding: 1em; }
    section { padding: 20px; }
    .before-after img { width: 48%; margin: 1%; border-radius: 8px; }
    form input, form select, form button {
      display: block; width: 100%; padding: 10px; margin: 10px 0;
      border: 1px solid #ccc; border-radius: 6px;
    }
    #map { height: 300px; margin-top: 15px; border-radius: 10px; }
    .note { color: green; margin-top: 10px; }
  </style>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>

<header id="pageHeader">
  <div style="padding: 20px 10px; text-align: center;">
    <h2 id="landingTitle" style="font-size: 28px;"></h2>
    <p id="landingDesc" style="color: #eee; font-size: 18px;"></p>
  </div>
</header>

<section>
  <img id="headerImage" alt="Ø¥Ø¹Ù„Ø§Ù†" width="100%" />
</section>

<section>
  <h2>ğŸ“¸ Ù†ØªØ§Ø¦Ø¬ Ø£Ø¹Ù…Ø§Ù„Ù†Ø§</h2>
  <div class="before-after">
    <img id="beforeImage" alt="Ù‚Ø¨Ù„ Ø§Ù„ØªÙ†Ø¸ÙŠÙ" />
    <img id="afterImage" alt="Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†Ø¸ÙŠÙ" />
  </div>
</section>

<section id="order">
  <h2>ğŸ“ Ù‚Ø¯Ù… Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø¢Ù†</h2>
  <form id="orderForm">
    <input type="text" id="name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required />
    <input type="tel" id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" required />
    <input type="text" id="address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" required />
    
    <label>ğŸ• Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø²ÙŠØ§Ø±Ø©:</label>
    <select id="preferredTime" required>
      <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨</option>
      <option value="ØµØ¨Ø§Ø­Ù‹Ø§">ØµØ¨Ø§Ø­Ù‹Ø§</option>
      <option value="Ù…Ø³Ø§Ø¡Ù‹">Ù…Ø³Ø§Ø¡Ù‹</option>
    </select>

    <label>ğŸ—’ï¸ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©:</label>
    <textarea id="notes" placeholder="Ø§ÙƒØªØ¨ Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªØ±ÙŠØ¯Ù‡Ø§..." rows="3" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px;"></textarea>

    <label>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙƒÙŠÙØ§Øª:</label>
    <input type="number" id="acCount" min="1" value="1" onchange="generateACFields()" required />
    <div id="acContainer"></div>

    <label>ğŸ“¸ ØµÙˆØ±Ø© Ø§Ù„Ù…ÙƒÙŠÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
    <input type="file" id="image" accept="image/*" capture="environment" />

    <button type="button" onclick="getLocation()">ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ</button>
    <p id="locationStatus" class="note"></p>
    <div id="map"></div>

    <button type="submit">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
  </form>
</section>

<section>
  <img id="footerImage" alt="ØªÙ†Ø¸ÙŠÙ Ø§Ø­ØªØ±Ø§ÙÙŠ" width="100%" />
</section>

<footer id="pageFooter">
  <p id="footerText">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© TopClim 2025</p>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore,
  doc,
  getDoc,
  collection,
  addDoc,
  serverTimestamp,
  getDocs,
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBjbzbSd1XM9eyXrgKaVj6xnZgIJuQmbRI",
  authDomain: "topclim-3edfa.firebaseapp.com",
  projectId: "topclim-3edfa",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let typeOptions = [];
let sizeOptions = [];

async function loadLandingContent() {
  const docRef = doc(db, "landing", "landingContent");
  const snap = await getDoc(docRef);
  if (snap.exists()) {
    const data = snap.data();
    document.getElementById("headerImage").src = data.bannerTop || "";
    document.getElementById("beforeImage").src = data.beforeImage || "";
    document.getElementById("afterImage").src = data.afterImage || "";
    document.getElementById("footerImage").src = data.bannerBottom || "";
    document.getElementById("landingTitle").textContent = data.headerTitle || "";
    document.getElementById("landingDesc").textContent = data.headerDesc || "";
    document.getElementById("footerText").textContent = data.footerText || "";
    if (data.headerColor) document.getElementById("pageHeader").style.backgroundColor = data.headerColor;
    if (data.footerColor) document.getElementById("pageFooter").style.backgroundColor = data.footerColor;
  }

  const typesSnap = await getDocs(collection(db, "acTypes"));
  const sizesSnap = await getDocs(collection(db, "acSizes"));

  typeOptions = typesSnap.docs.map(doc => `<option value="${doc.data().name}">${doc.data().name}</option>`);
  sizeOptions = sizesSnap.docs.map(doc => `<option value="${doc.data().label}">${doc.data().label}</option>`);

  generateACFields();
}

loadLandingContent();

window.generateACFields = function () {
  const count = parseInt(document.getElementById("acCount").value) || 1;
  const container = document.getElementById("acContainer");
  container.innerHTML = "";

  for (let i = 1; i <= count; i++) {
    container.innerHTML += `
      <div class="ac-group">
        <label>ğŸŒ€ Ù†ÙˆØ¹ Ø§Ù„Ù…ÙƒÙŠÙ ${i}</label>
        <select name="type${i}" required>
          <option disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
          ${typeOptions.join("")}
        </select>
        <label>ğŸ“ Ø­Ø¬Ù… Ø§Ù„Ù…ÙƒÙŠÙ ${i}</label>
        <select name="size${i}" required>
          <option disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ø­Ø¬Ù…</option>
          ${sizeOptions.join("")}
        </select>
      </div>
    `;
  }
};

// Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© Ù‚Ø¨Ù„ Ø±ÙØ¹Ù‡Ø§ (Ø¬ÙˆØ¯Ø© 60%)
function compressImage(file, quality = 0.6) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = (event) => {
      const img = new Image();
      img.src = event.target.result;
      img.onload = () => {
        const canvas = document.createElement("canvas");
        const scale = 800 / img.width;
        canvas.width = 800;
        canvas.height = img.height * scale;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        canvas.toBlob((blob) => {
          resolve(blob);
        }, "image/jpeg", quality);
      };
    };
    reader.readAsDataURL(file);
  });
}

document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("orderForm");
  const imageInput = document.getElementById("image");
  let userLocation = null;

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const btn = document.getElementById("sendBtn");
    btn.disabled = true;
    btn.innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";

    const name = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const address = document.getElementById("address").value.trim();
    const acCount = parseInt(document.getElementById("acCount").value);
    const preferredTime = document.getElementById("preferredTime").value;
    const notes = document.getElementById("notes").value;

    if (!preferredTime) {
      alert("âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø²ÙŠØ§Ø±Ø©.");
      btn.disabled = false;
      btn.innerText = "ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨";
      return;
    }

    const acUnits = [];
    for (let i = 1; i <= acCount; i++) {
      const type = form.querySelector(`[name=type${i}]`).value;
      const size = form.querySelector(`[name=size${i}]`).value;
      acUnits.push({ type, size });
    }

    let imageUrl = "";
    const imageFile = imageInput.files[0];
    if (imageFile) {
      try {
        const compressedImage = await compressImage(imageFile);
        const formData = new FormData();
        formData.append("file", compressedImage);
        formData.append("upload_preset", "topclim_upload");
        formData.append("folder", "TOPCLIMasset");

        const res = await fetch("https://api.cloudinary.com/v1_1/dtrmfg2om/upload", {
          method: "POST",
          body: formData,
        });

        const data = await res.json();
        imageUrl = data.secure_url;
      } catch (uploadError) {
        console.error("âŒ ÙØ´Ù„ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©:", uploadError);
        alert("âŒ ØªØ¹Ø°Ø± Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©. Ø¬Ø±Ø¨ Ù…Ø¬Ø¯Ø¯Ù‹Ø§ Ø£Ùˆ Ø¨Ø¯ÙˆÙ† ØµÙˆØ±Ø©.");
        btn.disabled = false;
        btn.innerText = "ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨";
        return;
      }
    }

    try {
      const docRef = await addDoc(collection(db, "requests"), {
        name,
        phone,
        address,
        acCount,
        acUnits,
        location: userLocation,
        imageUrl,
        preferredTime,
        notes,
        status: "Ù…Ø¨Ø¯Ø¦ÙŠ",
        createdAt: serverTimestamp(),
      });

      window.location.href = `track.html?id=${docRef.id}`;
    } catch (err) {
      console.error("âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨:", err);
      alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
      btn.disabled = false;
      btn.innerText = "ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨";
    }
  });

  window.getLocation = function () {
    const status = document.getElementById("locationStatus");
    status.textContent = "â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...";

    if (!navigator.geolocation) {
      status.textContent = "âŒ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.";
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (position) => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        const accuracy = position.coords.accuracy;

        userLocation = { lat, lng };
        status.innerHTML = `âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø¯Ù‚Ø© ~${Math.round(accuracy)} Ù…ØªØ±`;

        const map = L.map("map").setView([lat, lng], 15);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "Â© OpenStreetMap contributors",
        }).addTo(map);
        L.marker([lat, lng]).addTo(map).bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ").openPopup();
      },
      () => {
        status.textContent = "âŒ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.";
      },
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0,
      }
    );
  };
});
</script>


</body>
</html>
